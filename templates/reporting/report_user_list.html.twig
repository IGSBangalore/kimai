{% extends 'reporting/layout.html.twig' %}

{% block report_title %}{{ report_title|trans({}, 'reporting') }}{% endblock %}

{% block report %}

    {% embed '@AdminLTE/Widgets/box-widget.html.twig' %}
        {% import "macros/widgets.html.twig" as widgets %}
        {% block box_before %}
            {{ form_start(form, {'attr': {'class': 'form-inline', 'id': 'user-list-form'}}) }}
        {% endblock %}
        {% block box_after %}
            {{ form_end(form) }}
        {% endblock %}
        {% block box_title %}
            {{ form_widget(form.date) }}
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="{{ 'filter'|icon }}"></i> <span class="caret"></span>
                </button>
                <ul class="dropdown-menu checkbox-menu">
                    <li>
                        {{ form_widget(form.sumType) }}
                    </li>
                </ul>
            </div>
        {% endblock %}
        {% block box_body_class %}{{ box_id }} table-responsive {% if hasData %}no-padding{% endif %}{% endblock %}
        {% block box_body %}
            {% if not hasData %}
                {{ widgets.nothing_found() }}
            {% else %}
                {% set absoluteTotals = 0 %}
                {% set totals = {} %}
                {% set fieldName = form.sumType.vars.value %}
                {% set totalFieldName = 'total' ~ (fieldName | capitalize) %}
                {% set isDuration = (fieldName == 'duration') %}
                <table class="table table-bordered table-hover dataTable">
                    <thead>
                        <tr>
                            <th>&nbsp;</th>
                            <th>&nbsp;</th>
                            {% for day in stats.0.getDateTimes() %}
                                <th class="text-center text-nowrap{% if day is weekend %} weekend{% endif %}{% if day is today %} today{% endif %}">
                                    {{ day|date_weekday }}
                                </th>
                                {% set totals = totals|merge({(day|report_date): 0}) %}
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                    {% for userDay in stats %}
                        {% set usersTotalDuration = 0 %}
                        <tr class="user">
                            <td class="text-nowrap">
                                {{ widgets.label_dot(userDay.user.displayName, userDay.user.color) }}
                            </td>
                            {% for day in userDay.days %}
                                {% if day.totalDuration > 0 %}
                                    {% set usersTotalDuration = usersTotalDuration + attribute(day, totalFieldName) %}
                                    {% set absoluteTotals = absoluteTotals + attribute(day, totalFieldName) %}
                                {% endif %}
                                {% set totals = totals|merge({(day.date|report_date): (totals[day.date|report_date] + attribute(day, totalFieldName))}) %}
                            {% endfor %}
                            <th class="text-nowrap text-center total">
                                <a href="{{ path(subReportRoute, {'date': subReportDate|report_date, 'user': userDay.user.id}) }}">{{ isDuration ? usersTotalDuration|duration : usersTotalDuration }}</a>
                            </th>
                            {% for day in userDay.days %}
                                <td class="text-nowrap text-center day-total{% if day.date is weekend %} weekend{% endif %}{% if day.date is today %} today{% endif %}">
                                    {% if attribute(day, totalFieldName) > 0 %}
                                        {{ isDuration ? attribute(day, fieldName)|duration : attribute(day, fieldName) }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="summary">
                            <td>{{ 'stats.durationTotal'|trans }}</td>
                            <td class="text-center text-nowrap">
                                {{ isDuration ? absoluteTotals|duration : absoluteTotals }}
                            </td>
                            {% for id, columnTotal in totals %}
                                <td class="text-center text-nowrap">
                                    {{ isDuration ? columnTotal|duration : columnTotal }}
                                </td>
                            {% endfor %}
                        </tr>
                    </tfoot>
                </table>
            {% endif %}
        {% endblock %}
    {% endembed %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        document.addEventListener('kimai.initialized', function() {
            jQuery('#user-list-form').on('change', function(ev) {
                jQuery(this).submit();
            });
        });
    </script>
{% endblock %}
